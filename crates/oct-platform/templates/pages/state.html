{% extends "shared/base.html" %}

{% block title %}Infrastructure State{% endblock %}

{% block sidebar_actions %}{% endblock %}

{% block content %}
<div id="state-view" hx-target="this" hx-swap="outerHTML" class="max-w-6xl mx-auto space-y-8">

    <!-- Header -->
    <div class="flex items-center justify-between pb-6 border-b border-border">
        <h2 class="text-3xl font-bold text-main tracking-tight">Infrastructure State</h2>
        <div class="flex gap-3">
             <button class="px-4 py-2 bg-surface hover:bg-body text-accent-500 font-medium rounded-lg transition-all duration-200 flex items-center gap-2 border border-border hover:border-accent-500/50" hx-get="/projects/{{ project_name }}" hx-target="#state-view" hx-swap="outerHTML" hx-select="#project-view" hx-push-url="true">
              <i class="fa-solid fa-arrow-left"></i> Back to Project
          </button>
        </div>
    </div>

    <!-- Diagram -->
    <div class="bg-surface border border-border rounded-xl p-6"
         x-data="{
            mermaid: null,
            panZoomInstance: null,
            isRendering: false,
            originalContent: '',

            async init() {
                // Store original content for re-rendering
                const container = this.$refs.mermaidContainer;
                this.originalContent = container.innerHTML;

                // Load Mermaid
                const { default: mermaid } = await import('https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs');
                this.mermaid = mermaid;

                this.initMermaid();
                this.render();

                // Listen for theme changes
                this._themeHandler = () => {
                    this.initMermaid();
                    this.render();
                };
                window.addEventListener('theme-changed', this._themeHandler);
            },

            destroy() {
                if (this._themeHandler) {
                    window.removeEventListener('theme-changed', this._themeHandler);
                }
                if (this.panZoomInstance) {
                    this.panZoomInstance.destroy();
                }
            },

            initMermaid() {
                if (!this.mermaid) return;
                const isDark = document.documentElement.classList.contains('dark');
                this.mermaid.initialize({
                    startOnLoad: false,
                    theme: isDark ? 'dark' : 'default',
                    securityLevel: 'loose',
                    flowchart: {
                        useMaxWidth: false,
                        htmlLabels: true
                    }
                });
            },

            async render() {
                if (this.isRendering || !this.mermaid) return;

                const container = this.$refs.mermaidContainer;
                if (!container) return;

                this.isRendering = true;

                // Cleanup previous pan-zoom
                if (this.panZoomInstance) {
                    this.panZoomInstance.destroy();
                    this.panZoomInstance = null;
                }

                // Reset content
                container.removeAttribute('data-processed');
                container.innerHTML = this.originalContent;

                try {
                    await this.mermaid.run({ nodes: [container] });

                    const svg = container.querySelector('svg');
                    if (svg) {
                        svg.style.width = '100%';
                        svg.style.height = '100%';

                        // Initialize Pan-Zoom (assuming loaded globally via script tag)
                        if (typeof svgPanZoom !== 'undefined') {
                            this.panZoomInstance = svgPanZoom(svg, {
                                zoomEnabled: true,
                                controlIconsEnabled: true,
                                fit: true,
                                center: true,
                                minZoom: 0.1,
                                maxZoom: 10,
                            });
                        }

                        container.classList.remove('opacity-0');
                    }
                } catch (e) {
                    console.error('Mermaid render error:', e);
                    if (!container.querySelector('svg')) {
                        container.textContent = 'Failed to render diagram.';
                    }
                    container.classList.remove('opacity-0');
                } finally {
                    this.isRendering = false;
                }
            }
         }">
        <h3 class="text-xl font-semibold text-main mb-4 flex items-center gap-2">
            <i class="fa-solid fa-diagram-project text-muted"></i>
            Dependency Graph
        </h3>
        <!-- Container for Mermaid -->
        <div class="mermaid-container w-full h-[600px] bg-body/50 rounded-lg overflow-hidden relative border border-border">
            <pre x-ref="mermaidContainer" class="mermaid w-full h-full flex items-center justify-center opacity-0 transition-opacity duration-300">
{{ mermaid_graph|safe }}
            </pre>
        </div>
    </div>

    <!-- Raw State -->
    <div class="bg-surface border border-border rounded-xl p-6">
         <h3 class="text-xl font-semibold text-main mb-4 flex items-center gap-2">
            <i class="fa-solid fa-code text-muted"></i>
            Raw State (JSON)
        </h3>
        <div class="bg-body border border-border rounded-xl p-4 overflow-x-auto">
            <pre class="font-mono text-sm"><code>{{ state_json }}</code></pre>
        </div>
    </div>

</div>

<!-- Load svg-pan-zoom (global scope) -->
<script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
{% endblock %}
